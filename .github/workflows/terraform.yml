name: ğŸ—ï¸ Infrastructure (Terraform)

on:
  push:
    branches: [ main ]
    paths: [ 'terraform/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'terraform/**' ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-west-2'

jobs:
  terraform-validate:
    name: ğŸ” Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸ”§ Terraform Format Check
      run: |
        cd terraform
        terraform fmt -check -recursive
        
    - name: âœ… Terraform Validate
      run: |
        cd terraform
        terraform init -backend=false
        terraform validate

  terraform-security:
    name: ğŸ”’ Security Scan (tfsec)
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ›¡ï¸ Run tfsec
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        soft_fail: false
        working_directory: terraform

  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-security]
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸš€ Terraform Init
      run: |
        cd terraform
        terraform init
        
    - name: ğŸ“‹ Terraform Plan
      run: |
        cd terraform
        terraform plan -out=tfplan -var-file=terraform.tfvars
        
    - name: ğŸ“Š Upload Plan
      uses: actions/upload-artifact@v3
      with:
        name: terraform-plan
        path: terraform/tfplan

  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'))
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸš€ Terraform Init
      run: |
        cd terraform
        terraform init
        
    - name: ğŸ“‹ Terraform Plan
      run: |
        cd terraform
        terraform plan -var-file=terraform.tfvars
        
    - name: ğŸš€ Terraform Apply
      run: |
        cd terraform
        terraform apply -auto-approve -var-file=terraform.tfvars
        
    - name: ğŸ“Š Save Outputs
      run: |
        cd terraform
        terraform output -json > ../terraform-outputs.json
        
    - name: ğŸ“¤ Upload Outputs
      uses: actions/upload-artifact@v3
      with:
        name: terraform-outputs
        path: terraform-outputs.json

  terraform-destroy:
    name: ğŸ’¥ Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸš€ Terraform Init
      run: |
        cd terraform
        terraform init
        
    - name: ğŸ’¥ Terraform Destroy
      run: |
        cd terraform
        terraform destroy -auto-approve -var-file=terraform.tfvars